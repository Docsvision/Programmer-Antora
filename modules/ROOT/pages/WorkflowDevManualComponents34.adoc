= Сохранение сценария в виде сборки

Начиная с версии {dv} 4.5 в _функцию_ "Сценарий" добавлена возможность компиляции кода для получения готовой сборки (DLL), которую можно повторно использовать в бизнес-процессах. Последовательность получения сборки следующая:

. Создайте новый бизнес-процесс или используйте имеющийся.
. Добавьте в _бизнес-процесс_ функцию "Сценарий".
+
image::build_script.PNG[image]
. В _сценарии_ напишите скрипт, который будет содержать необходимую функциональность и будет соответствовать следующим требованиям:
[loweralpha]
.. Должен содержать минимум один публичный (publiс) класс.
.. Должны присутствовать публичные статические (public static) методы. В рамках одного _сценария_ возможно наличие произвольного числа таких методов -- каждый из них будет выступать как отдельная _функция_ в "Универсальной функции".
+
[IMPORTANT]
====
Аргументы данного метода, также как и возвращаемое значение (если предусмотрено) должны иметь тип, реализованный шлюзами Workflow (включая шлюз к базовым типам).
====
+
Ниже приведен пример скрипта, в котором доступен один метод SaveCard, подразумевающий выполнение действий над переданной карточкой `card`.
+
[source,csharp]
----
// Подключение системных библиотек
using System;
using System.Xml;
using System.ComponentModel;

// Подключение библиотек СУБП
using DocsVision.Workflow.Gates;

namespace SampleCode
{ 
 public class SampleFunc
 {
  public static void SaveCard(DVCard card)
  {
    // Выполнение действие с объектом card

  }
 }
}
----
. Выполните проверку корректности скрипта (кнопка *Компилировать*).
. В том случае, если ошибок при компиляции не обнаружено, нажмите *Создать сборку*. Система предложит выбрать место для сохранения библиотеки. Нужно учитывать, что итоговая сборка должна быть доступна сервису Workflow, для этого её достаточно поместить в каталог приложения Workflow (исполняемый файл `ExecLogic.exe`), либо зарегистрировать в GAC.
. Выполните сохранение, нажмите *OK*.

Ссылка на сборку будет автоматически добавлена в список сборок Workflow (справочника _Системных настроек_). Это позволит в дальнейшем использовать данный _сценарий_ в других процессах в виде _функции_, без необходимости копирования его исходного кода.

Для того, чтобы обратиться к методам полученной сборки:

. Создайте новый бизнес-процесс или используйте имеющийся.
. Добавьте в процесс _функцию_ "Универсальная функция".
. Выберите Тип. При выборе ориентируйтесь на название сборки, созданной ранее. В качестве типа может быть выбран один из классов, реализованных в скрипте.
. Выберите Функцию. Для выбора доступны статические публичные методы класса, выбранного ранее.
. При необходимости указать значения Параметров функции. Параметры функции соответствую параметрам выбранного метода.
. Сохраните настройки (*ОК*).
+
image::build_script_3.PNG[image]

Для того, чтобы реализованные классы и методы имели локализованное название, при отображении в окне параметров "Универсальной функции", пометьте эти сущности специальным атрибутом ResName

[source,csharp]
----
// Подключение системных библиотек
using System;
using System.Xml;
using System.ComponentModel;

// Подключение библиотек СУБП
using DocsVision.Workflow.Gates;

namespace SampleCode
{ 
 [ResName("Пример функции")]
 public class SampleFunc
 {
  [ResName("Пример метода функции")]
  public static void SaveCard([ResName("Переменная")] DVCard card)
  {
    // Выполнение действие с объектом card

  }
 }

 // internal sealed class ResNameAttribute : DescriptionAttribute 
}
----

Класс ResNameAttribute требуется реализовать самостоятельно по следующему примеру

[source,csharp]
----
[System.AttributeUsage(System.AttributeTargets.All)]
internal sealed class ResNameAttribute : DescriptionAttribute 
{ 
 public ResNameAttribute(string name) : base(name) { }
}
----

Данный класс может быть включен в сборку с получаемым _сценарием_, либо вынесен в отдельную библиотеку.

После получения библиотеки с локализованными названиями, окно настройки "Универсальной функции" будет как показано ниже.

image::build_script_2.PNG[image]

Помимо сборок, созданных на базе _сценариев_, возможно подключение в таком качестве любых произвольных сборок, отвечающих тем же требованиям. Данные библиотеки должны быть самостоятельно зарегистрированы в качестве модуля Workflow. Регистрация осуществляется в категории "Настройки Workflow/Сборки" справочника "Системные настройки" (папка "Конструкторы и справочники") приложения *Docsvision {wincl}*. Сборка должна быть доступна сервису Workflow (см. выше).
