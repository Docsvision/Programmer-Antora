= Подписка на события шлюза

Workflow предоставляет разработчикам механизм формирования подписок на определенные события xref:WorkflowDevManualComponents1.adoc[шлюза], к примеру, если функция должна продолжить работу, только после разблокировки определенной карточки.

== Механизм формирование подписок и сообщений

Шлюз, чей серверный компонент реализует специальный интерфейс [.keyword .apiname]#IGateMessageSource#(сборка `DocsVision.Workflow.Interfaces.dll`), предоставляет канал для формирования подписок. Доступ к нему может быть получен через публичное свойство шлюза - SubscriptionChannel (тип xref:..xref:api/DocsVision/Workflow/Gates/ISubscriptionChannel_IN.adoc[ISubscriptionChannel]), к примеру так:

[source,csharp]
----
// Получение шлюза к Docsvision
DVGate dvGate = (DVGate)process.Gates[DVGate.GateID];

// Получение канала подписок
SubscriptionChannel subscriptionChannel = dvGate.SubscriptionChannel;
----

После получения канала подписок, разработчик может выполнить подписку на определенное событие, например, подписаться на событие разблокировки определенной карточки Docsvision:

[source,csharp]
----
// cardId - идентификатор карточки, у которой ожидается разблокировка
subscriptionChannel.Subscribe((int)DocsVisionSubscriptionType.ObjectUnlock, process.ID, passInfo.FunctionID, cardId);
----

Метод xref:..xref:api/DocsVision/Workflow/Gates/ISubscriptionChannel.Subscribe_MT.adoc[Subscribe] принимает (по порядку передачи параметров):

. Тип ожидаемого события шлюза. Список событий индивидуален для каждого шлюза (см. далее по тексту), который в дальнейшем отвечает за обработку подписок, а также генерирует сообщения для функций, осуществивших подписку.
. Идентификатор процесса (бизнес-процесса), который подписывается на события, и который должен получить сообщение о наступлении события шлюза.
. Идентификатор функции, которая выполняет подписку на событие.

Также может быть передан (как в примере) дополнительный параметр (с типом [.keyword .apiname]#Guid# или [.keyword .apiname]#String#), тип и значение которого зависят от типа ожидаемого события шлюза (см. далее по тексту).

Если функция выполняет подписку на событие, то об этом необходимо проинформировать Workflow, вернув значение ExecResultEnum.WaitForMessage.

После подписки на событие, функция переходит в режиме ожидания и активируется при появлении сообщения соответствующего типа.

В общем случае, сценарий подписки и оповещения выглядит следующим образом:

. _Менеджер процессов_ (часть *ExecLogic*) вызывает метод [.keyword .apiname]#Execute# текущей функции (к примеру, *Функции N*), которая должна быть запущена.
. _Функции N_, если это необходимо, оформляет подписку на событие в определенном шлюзе (к примеру, *Шлюз T*), посредством вызова метода [.keyword .apiname]#Subscribe#, и возвращает значение [.keyword .apiname]#ExecResultEnum.WaitForMessage#.
. _Шлюз T_, проверяет наличие подписок в своем хранилище (например, в базе данных) и организует проверку наступления соответствующего события.
. При наступлении события _Шлюз T_ добавляет сообщение для _Функции N_, через вызов метода [.keyword .apiname]#SendMessage#. Сообщение добавляется в очередь сообщений конкретного процесса.
. _Менеджер процессов_ проверяет очередь сообщений и, в случае наличия сообщения для _Функции N_, вызывает метод [.keyword .apiname]#Execute# _Функции N_.

Схематично данный сценарий можно представить следующим образом:

image::workflowSubscription.png[[.fig--title-label]##Рис. 1. ##Сценарий подписки на событие шлюза и формирования сообщения о его наступлении]

== События шлюза к Docsvision

Шлюз к Docsvision разрешает подписку на следующие события (см. описание xref:..xref:api/DocsVision/Workflow/Gates/DocsVisionSubscriptionType_EN.adoc[DocsVisionSubscriptionType]):

* CardChange - изменение заданной карточки. При вызове [.keyword .apiname]#Subscribe# необходимо передать (четвертый параметр) идентификатор отслеживаемой карточки.
* AnyCardChange - изменение любой карточки заданного типа. При вызове [.keyword .apiname]#Subscribe# необходимо передать (четвертый параметр) идентификатор типа отслеживаемых карточек.
* ObjectUnlock - разблокировка заданной карточки. При вызове [.keyword .apiname]#Subscribe# необходимо передать (четвертый параметр) идентификатор соотвествующей карточки.
* ObjectLock - блокировка заданной карточки. При вызове [.keyword .apiname]#Subscribe# необходимо передать (четвертый параметр) идентификатор соотвествующей карточки.

== События шлюза к файловой системе

Шлюз к файловой системе обеспечивает возможность подписки на события (см. описание xref:..xref:api/DocsVision/Workflow/Gates/FSSubscriptionType_EN.adoc[FSSubscriptionType]):

* NewFileInFolder - добавление файла в указанную папку. При вызове [.keyword .apiname]#Subscribe# необходимо передать (четвертый параметр) сериализованный (XML-сериализация) объект типа xref:..xref:api/DocsVision/Workflow/Gates/FSSubscriptionInfo_CL.adoc[FSSubscriptionInfo] - параметры подписки.
* FileChange - изменение указанного файла. При вызове [.keyword .apiname]#Subscribe# необходимо передать (четвертый параметр) сериализованный объект типа xref:..xref:api/DocsVision/Workflow/Gates/FSSubscriptionInfo_CL.adoc[FSSubscriptionInfo].

== События шлюза к почтовой системе

Шлюз к почтовой системе обеспечивает возможность подписки на события (см. описание xref:..xref:api/DocsVision/Workflow/Gates/MailSubscriptionType_EN.adoc[MailSubscriptionType]):

* NewMessage - поступление нового сообщения. При вызове [.keyword .apiname]#Subscribe# необходимо передать (четвертый параметр) сериализованный объект типа xref:..xref:api/DocsVision/Workflow/Gates/MailFilter_CL.adoc[MailFilter] - фильтр для новых сообщений.
* MessageWithSubstringInSubject - поступление нового сообщения с заданным тестом в заголовке письма. При вызове [.keyword .apiname]#Subscribe# необходимо передать (четвертый параметр) текст, который должен содержаться в заголовке ожидаемого письма.

== Подписка на события шлюзов функциями приложения "Управление процессами"

Некоторые функции приложения "Управление процессами" используют подписку в своей работе. Ниже приведен полный список функций приложения "Управление процессами", а также события, на которые они могут быть подписаны. Конкретный тип события, на которое подписывается функция, может зависеть от ее конкретных настроек.

[width="99%",cols="34%,66%",options="header"]
|===
|Функция |События, на которые возможна подписка
|_Базовые функции_ |
|Начальная функция |Не подписывается
|Конечная функция |Не подписывается
|Объединение 'И' |Не подписывается, но может ожидать завершения другой функции
|Объединение 'Или' |Не подписывается
|Разветвление |Не подписывается
|Подпроцесс |Не подписывается, но ожидает завершения другого подпроцесса
|Условие |Не подписывается
|Счетчик |Не подписывается
|Обработка коллекции |Не подписывается
|Удаление объекта |Не подписывается, но ожидает завершения удаления объекта
|Сценарий |Может подписывается на любые события шлюзов, если это реализовано разработчиком
|Обмен данными между переменными |Не подписывается
|Расписание |Подписывается на событие от таймера (Шлюз к простым типам)
|Универсальный обмен данными |Не подписывается, но ожидает завершения обмена
|Универсальная функция |Может подписывается на любые события шлюзов, если это реализовано разработчиком выбранной функции
|Обработчик ошибок |Не подписывается
|_Функции шлюза к Docsvision_ |
|Мониторинг Docsvision |Может подписываться на изменение определенной карточки, либо карточек определенного типа
|Задание |Может подписываться на поступление письма (Шлюз к почтовой системе), на событие от таймера (Шлюз к простым типам), на изменение или разблокировку карточек
|Управление заданием |Не подписывается, но остается активным, если карточка заблокирована
|Ярлык |Не подписывается
|Функция рассылки согласований |Может подписываться на разблокировку карточки, поступление письма (Шлюз к почтовой системе), а также ожидать завершения подпроцесса
|Функция рассылки заданий |Может подписываться на разблокировку карточки, а также ожидать завершения подпроцесса
|Задание 5 |Может подписываться на поступление письма (Шлюз к почтовой системе), на событие от таймера (Шлюз к простым типам), на изменение или разблокировку карточек
|Параллельное задание |Может подписываться на разблокировку родительской и связанных карточек, а также ожидать завершения подпроцесса
|Последовательное задание |Может подписываться на разблокировку родительской и связанных карточек, а также ожидать завершения подпроцесса
|_Функции шлюза к файловой системе_ |
|Мониторинг файловой системы |Может подписываться на появление нового файла и изменение файла
|_Функции шлюза к почтовой системе_ |
|Мониторинг сообщений |Может подписываться на появление нового сообщения (и сообщения с определенной темой).
|Сообщения задания 5 |Может подписываться на появление нового сообщения, а также на изменение и разблокировку конкретного задания или всех карточек типа задание.
|===
