= Использование отчетов

Отчет – механизм Docsvision, предоставляющий возможность получения прямого доступ к БД Docsvision с целью получения сложных выборок данных; повышения производительности работы Решения; получения данных из внешней БД и т.п.

[NOTE]
====
[.note__title]#Важное замечание:# Отчет работает с данными минуя модели безопасности Docsvision, поэтому задача обеспечения защиты данных, в данном случае, возлагается на разработчика.

Создание отчетов требует от разработчика понимания внутреннего устройства БД Docsvision.
====

== Создание отчета

Создание нового отчета включает два этапа:

. Разработка SQL процедуры, реализующей требуемых механизм взаимодействие с данными в БД.
. Настрйока отчета в схеме библиотеки карточек.

Отчет представляет собой SQL процедуру вида:

[source,pre,codeblock]
----
BEGIN
 SELECT tblMy.Info1, tblMy.Info2
 FROM [dvtable_{SOME_DV_TABLE_GUID_HERE}] tblMy
 WHERE tblMy.Param1 = @Param1 and tblMy.Param2 = @Param2
 ORDER BY tblMy.Info2
END
----

В процедуре можно использовать параметры (с символом «@»), значения которых будут переданы при вызове отчета. Параметры объявлять не требуется.

Процедура может возвращать или не возвращать значения. Возвращаемые значения могут представлять собой единственное значение или таблица.

Процедура должна размещаться в блоке BEGIN .. END.

Заголовок хранимой процедуры и описания параметров будут сгененированы автоматически.

Процедура должна быть сохранена в файл SQL в подпапку (например, «Sql») в одном каталоге со схемой библиотеки карточек.

[source,pre,codeblock]
----
CardLib
|  MyCardLib.xml
|  MyCard.xml
|--Sql
   |  MyProcedure1.sql
   |  MyProcedure1.sql
----

Регистрация отчета в схеме библиотеки карточек выполняется с помощью программы «CardManager». Инструкция по работе с программой приведена в документе _Комплект программных инструментов «Resource Kit». Руководство пользователя_.

В качестве примера, далее будет выполнена регистрация отчета GetLogMessages, возвращающего записи из журнала Docsvision за определенный период:

[source,pre,codeblock]
----
BEGIN
    SELECT appLog.EmployeeID, appLog.Date, appLog.Data
    FROM [dbo].[dvsys_log_application] appLog WITH(NOLOCK)
    INNER JOIN [dbo].dvsys_users users WITH(NOLOCK)
    ON (users.UserID = appLog.UserID)
    WHERE appLog.Date BETWEEN @DateFrom AND @DateTo
END 
----

Чтобы настроить новый отчет:

. Откройте в программе «CardManager» свойства собственной библиотеки карточек и перейдите на вкладку Reports.
+
image::cardManagerReports.png[[.fig--title-label]##Рис. 1. ##Страница настройки отчетов библиотеки карточек в программе «CardManager»]
. Добавьте новый отчет в схему и укажите основные свойства отчета.
[loweralpha]
.. Нажмите кнопку Add в блоке Procedures. В список Procedures будет добавлена новая запись.
.. В поле Alias введите псевдоним отчета.
.. В таблице Названия введите локализованные названия отчета.
+
В поле ID будет указан автоматически сгенерированный идентификатор отчета, по которому отчет может быть вызван с использованием API.
+
image::cardManagerReportsBaseConf.png[[.fig--title-label]##Рис. 2. ##Пример настройки основных свойств отчета]
. Добавьте в отчет файлы с SQL процедурами на странице SQL files.
[loweralpha]
.. Нажмите кнопку Add на данной странице. В список Files будет добавлена новая запись.
.. В поле SQL file выберите разработанный ранее SQL файл с процедурой отчета. Приведите путь к файлу к относительному виду.
.. В списке Server type выберите тип СУБД, по управлением которой работает БД Docsvision, для которой создается отчет: MsSql или PostgreSql.
+
image::cardManagerReportsFileConf.png[[.fig--title-label]##Рис. 3. ##Пример настройки файлов отчета]
. Настройте параметры отчета на странице Parameters.
[loweralpha]
.. Нажмите кнопку Add на данной странице. В список Parameters будет добавлена новая запись.
.. В поле Parameter name введите название параметра, которое ожидается разработанной SQL процедурой.
.. В поле Parameter type тип параметра, соответствующий типу параметра, используемого в SQL процедуре.
.. Аналогичным образом добавьте все параметры, ожидаемые разработанной SQL процедурой.
+
image::cardManagerReportsParamConf.png[[.fig--title-label]##Рис. 4. ##Пример настройки параметров отчета]
. Настройте возвращаемые данные отчета на странице Report result.
[loweralpha]
.. Выберите формат возвращаемого значения:
* Scalar result – если возвращается единственного значение;
* TableResult – если возвращается коллекция значений.
.. Если выбран формат «Scalar result», укажите:
* Data type – тип возвращаемых данных;
* Precision, Scale, Size – точность, масштаб и длина (см. https://docs.microsoft.com/ru-ru/sql/t-sql/data-types/precision-scale-and-length-transact-sql);
* Nullable – если может быть пустым.
.. Если выбран формат «TableResult»:
[lowerroman]
... Нажмите кнопку Add. В список Columns будет добавлена новая запись.
... В поле Name введите название возвращаемого процедурой поля.
... Укажите (см. описание выше): Data type, Precision, Scale, Size и Nullable.
... Аналогичным образом добавьте *все возвращаемые процедурой поля*. Данное условие критически важно при работе с PostgreSQL.
+
image::cardManagerReportsResultConf.png[[.fig--title-label]##Рис. 5. ##Пример настройки результатов отчета]
. Сохраните настройки библиотеки карточек и загрузите её в Docsvision стандартным образом.
. Перезапустите сервер Docsvision.

== Вызов отчета

Для работы с отчетами API Docsvision предоставляет менеджер отчетов типа xref:..xref:api/DocsVision/Platform/ObjectManager/ReportManager_CL.adoc[ReportManager].

Все отчеты содержатся в поле Reports класса ReportManager. Получить требуемый отчет можно по его идентификатору, который был присвоен в схеме библиотеки карточек:

[source,pre,codeblock]
----
var report = userSession.ReportManager.Reports[Guid.Parse("886d96f1-e92f-44aa-b22d-9b324aeb5abc")];
----

Значения параметров отчета устанавливаются в поле Parameters:

[source,pre,codeblock]
----
report.Parameters["DateFrom"].Value = DateTime.Parse("01.01.2012");
report.Parameters["DateTo"].Value = DateTime.Parse("01.01.2019");
----

Выполнение отчета запускается методом report.GetData(), который возвращает набор строк с результатами выполнения.

Следующий код демонстрирует пример вызова разработанного отчета с отображением записей журнала Docsvision в консоли.

[source,csharp]
----
// Получение отчета с идентификатором 886d96f1-e92f-44aa-b22d-9b324aeb5abc
var report = userSession.ReportManager.Reports[Guid.Parse("886d96f1-e92f-44aa-b22d-9b324aeb5abc")];

// Заполнения параметров отчета (начальной и конечной даты выборки)
report.Parameters["DateFrom"].Value = DateTime.Parse("01.01.2012");
report.Parameters["DateTo"].Value = DateTime.Parse("01.01.2019");

// Выполнение отчета
InfoRowCollection results = report.GetData();

// Отображение результатов выполнения отчета в консоли
foreach (InfoRow result in results)
{
  Console.WriteLine("{0} | {1} | {2}", result["EmployeeID"].ToString(),result["Date"].ToString(), result["Data"].ToString());
}
----

Способ отображения данных отчета в пользовательском интерфейсе реализуется разработчиком самостоятельно.

== См. также

* xref:dm_numerators.adoc[Работа с нумераторами]
