= Использование отчетов

Отчет -- механизм, предоставляющий возможность получения прямого доступ к БД {dv} с целью получения сложных выборок данных, повышения производительности работы Решения, получения данных из внешней БД и т.п.

[IMPORTANT]
====
Отчет работает с данными минуя модели безопасности {dv}, поэтому задача обеспечения защиты данных, в данном случае, возлагается на разработчика.

Создание отчетов требует от разработчика понимания внутреннего устройства БД {dv}.
====

== Создание отчета

.Создание нового отчета включает два этапа:
. Разработка SQL-процедуры, реализующей требуемый механизм взаимодействие с данными в БД.
. Настройка отчета в схеме библиотеки карточек.

.Отчет представляет собой SQL процедуру вида:
[source,sql]
----
BEGIN
 SELECT tblMy.Info1, tblMy.Info2
 FROM [dvtable_{SOME_DV_TABLE_GUID_HERE}] tblMy
 WHERE tblMy.Param1 = @Param1 and tblMy.Param2 = @Param2
 ORDER BY tblMy.Info2
END
----

В процедуре можно использовать параметры (с символом `@`), значения которых будут переданы при вызове отчета. Параметры объявлять не требуется.

Процедура может возвращать или не возвращать значения. Возвращаемые значения могут представлять собой единственное значение или таблица.

Процедура должна размещаться в блоке `BEGIN` .. `END`.

Заголовок хранимой процедуры и описания параметров будут сгененированы автоматически.

Процедура должна быть сохранена в файл `.sql` в подпапку (например, "Sql") в одном каталоге со схемой библиотеки карточек.

[source]
----
CardLib
|  MyCardLib.xml
|  MyCard.xml
|--Sql
   |  MyProcedure1.sql
   |  MyProcedure1.sql
----

Регистрация отчета в схеме библиотеки карточек выполняется с помощью программы "CardManager". Инструкция по работе с программой приведена в Руководстве пользователя Resource Kit.

В качестве примера далее будет выполнена регистрация отчета `GetLogMessages`, возвращающего записи из журнала {dv} за определённый период:

[source,sql]
----
BEGIN
    SELECT appLog.EmployeeID, appLog.Date, appLog.Data
    FROM [dbo].[dvsys_log_application] appLog WITH(NOLOCK)
    INNER JOIN [dbo].dvsys_users users WITH(NOLOCK)
    ON (users.UserID = appLog.UserID)
    WHERE appLog.Date BETWEEN @DateFrom AND @DateTo
END 
----

.Чтобы настроить новый отчет:
. Откройте в программе "CardManager" свойства собственной библиотеки карточек и перейдите на вкладку _Reports_.
+
.Вкладка настройки отчетов библиотеки карточек в программе "CardManager"
image::card-manager-reports.png[Вкладка настройки отчетов библиотеки карточек в программе "CardManager"]
+
. Добавьте новый отчет в схему и укажите основные свойства отчета.
+
.. Нажмите кнопку *Add* в блоке _Procedures_. В список _Procedures_ будет добавлена новая запись.
.. В поле _Alias_ введите псевдоним отчета.
.. В таблице _Названия_ введите локализованные названия отчета.
+
В поле ID будет указан автоматически сгенерированный идентификатор отчета, по которому отчет может быть вызван с использованием API.
+
.Пример настройки основных свойств отчета
image::card-manager-reports-base-config.png[Пример настройки основных свойств отчета]
+
. Добавьте в отчет файлы с SQL процедурами на вкладке _SQL files_.
+
.. Нажмите кнопку *Add* на данной вкладке. В список _Files_ будет добавлена новая запись.
.. В поле _SQL file_ выберите разработанный ранее SQL-файл с процедурой отчета. Приведите путь к файлу к относительному виду.
.. В списке _Server type_ выберите тип СУБД, под управлением которой работает БД {dv}, для которой создается отчет: *_MsSql_* или *_PostgreSql_*.
+
.Пример настройки файлов отчета
image::card-manager-reports-file-config.png[Пример настройки файлов отчета]
+
. Настройте параметры отчета на вкладке _Parameters_.
+
.. Нажмите кнопку *Add* на данной странице. В список _Parameters_ будет добавлена новая запись.
.. В поле _Parameter_ name введите название параметра, которое ожидается в соответствии с разработанной SQL-процедурой.
.. В поле _Parameter type_ укажите тип параметра, соответствующий типу параметра, используемого в SQL-процедуре.
.. Аналогичным образом добавьте все параметры, ожидаемые разработанной SQL-процедурой.
+
.Пример настройки параметров отчета
image::card-manager-reports-parameter-config.png[Пример настройки параметров отчета]
+
. Настройте возвращаемые данные отчета на вкладке _Report result_.
+
.. Выберите формат возвращаемого значения:
+
* *_Scalar result_* -- если возвращается единственное значение.
* *_TableResult_* -- если возвращается коллекция значений.
+
.. Если выбран формат *_Scalar result_*, укажите:
+
* [[above]]_Data type_ -- тип возвращаемых данных.
* _Precision_, _Scale_, _Size_ -- точность, масштаб и длина (см. https://docs.microsoft.com/ru-ru/sql/t-sql/data-types/precision-scale-and-length-transact-sql[подробнее] на сайте Microsoft.).
* _Nullable_ -- если может быть пустым.
+
.. Если выбран формат *_TableResult_*:
+
... Нажмите кнопку *Add*. В список _Columns_ будет добавлена новая запись.
... В поле _Name_ введите название возвращаемого процедурой поля.
... Укажите (см. описание <<above,выше>>): _Data type_, _Precision_, _Scale_, _Size_ и _Nullable_.
... Аналогичным образом добавьте *все* возвращаемые процедурой поля. Данное условие критически важно при работе с PostgreSQL.
+
.Пример настройки результатов отчета
image::card-manager-reports-result-config.png[Пример настройки результатов отчета]
+
. Сохраните настройки библиотеки карточек и загрузите её в {dv} стандартным образом.
. Перезапустите сервер {dv}.

== Вызов отчета

Для работы с отчетами API {dv} предоставляет менеджер отчетов типа xref:api/DocsVision/Platform/ObjectManager/ReportManager_CL.adoc[`ReportManager`].

Все отчеты содержатся в поле _Reports_ класса `ReportManager`.

.Получить требуемый отчет можно по его идентификатору, который был присвоен в схеме библиотеки карточек:
[source,csharp]
----
var report = userSession.ReportManager.Reports[Guid.Parse("886d96f1-e92f-44aa-b22d-9b324aeb5abc")];
----

.Значения параметров отчета устанавливаются в поле `Parameters`:
[source,csharp]
----
report.Parameters["DateFrom"].Value = DateTime.Parse("01.01.2012");
report.Parameters["DateTo"].Value = DateTime.Parse("01.01.2019");
----

Выполнение отчета запускается методом `report.GetData()`, который возвращает набор строк с результатами выполнения.

Следующий код демонстрирует пример вызова разработанного отчета с отображением записей журнала {dv} в консоли.

[source,csharp]
----
var report = userSession.ReportManager.Reports[Guid.Parse("886d96f1-e92f-44aa-b22d-9b324aeb5abc")]; <.>

report.Parameters["DateFrom"].Value = DateTime.Parse("01.01.2012");
report.Parameters["DateTo"].Value = DateTime.Parse("01.01.2019"); <.>

InfoRowCollection results = report.GetData(); <.>

foreach (InfoRow result in results)
{
  Console.WriteLine("{0} | {1} | {2}", result["EmployeeID"].ToString(),result["Date"].ToString(), result["Data"].ToString()); <.>
}
----
<.> Получение отчета с идентификатором `886d96f1-e92f-44aa-b22d-9b324aeb5abc`.
<.> Заполнения параметров отчета -- начальной и конечной даты выборки.
<.> Выполнение отчета.
<.> Отображение результатов выполнения отчета в консоли.

Способ отображения данных отчета в пользовательском интерфейсе реализуется разработчиком самостоятельно.
