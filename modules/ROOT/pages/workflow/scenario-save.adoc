= Сохранение сценария в виде сборки

Начиная с версии {dv} 4.5 в _функцию_ "Сценарий" добавлена возможность компиляции кода для получения готовой сборки (DLL), которую можно повторно использовать в бизнес-процессах.

.Последовательность получения сборки следующая:
. Создайте новый бизнес-процесс или используйте имеющийся.
. Добавьте в _бизнес-процесс_ функцию "Сценарий".
+
.Компиляция скрипта из {dv}
image::build-script.png[Компиляция скрипта из {dv}]
+
. В _сценарии_ напишите скрипт, который будет содержать необходимую функциональность и будет соответствовать следующим требованиям:
.. Должен содержать минимум один публичный (`publiс`) класс.
.. Должны присутствовать публичные статические (`public static`) методы. В рамках одного _сценария_ возможно наличие произвольного числа таких методов -- каждый из них будет выступать как отдельная _функция_ в "Универсальной функции".
+
[IMPORTANT]
====
Аргументы данного метода, так же как и возвращаемое значение (если предусмотрено) должны иметь тип, реализованный шлюзами Workflow (включая шлюз к базовым типам).
====
+
Ниже приведен пример скрипта, в котором доступен один метод `SaveCard`, подразумевающий выполнение действий над переданной карточкой `card`.
+
[source,csharp]
----
using System;
using System.Xml;
using System.ComponentModel; <.>

using DocsVision.Workflow.Gates; <.>

namespace SampleCode
{ 
 public class SampleFunc
 {
  public static void SaveCard(DVCard card)
  {
<.>
  }
 }
}
----
<.> Подключение системных библиотек.
<.> Подключение библиотек СУБП.
<.> Выполнение действие с объектом `card`.
+
. Выполните проверку корректности скрипта (кнопка *Компилировать*).
. Если ошибок при компиляции не обнаружено, нажмите кнопку *Создать сборку*.
+
Система предложит выбрать место для сохранения библиотеки. Нужно учитывать, что итоговая сборка должна быть доступна сервису Workflow. Для этого её достаточно поместить в каталог приложения Workflow (исполняемый файл `ExecLogic.exe`), либо зарегистрировать в GAC.
+
. Выполните сохранение, нажмите *OK*.
+
Ссылка на сборку будет автоматически добавлена в список сборок Workflow (справочника _Системных настроек_). Это позволит в дальнейшем использовать данный _сценарий_ в других процессах в виде _функции_, без необходимости копирования его исходного кода.

.Чтобы обратиться к методам полученной сборки:
. Создайте новый бизнес-процесс или используйте имеющийся.
. Добавьте в процесс _функцию_ "Универсальная функция".
. Выберите _Тип_.
+
При выборе ориентируйтесь на название сборки, созданной ранее. В качестве типа может быть выбран один из классов, реализованных в скрипте.
+
. Выберите _Функцию_.
+
Для выбора доступны статические публичные методы класса, выбранного ранее.
+
. При необходимости укажите значения _Параметров_ функции.
+
Параметры функции соответствую параметрам выбранного метода.
+
. Сохраните настройки нажатием кнопки *ОК*.
+
.Созданный скрипт в области "Параметры функции"
image::save-script.png[Созданный скрипт в области "Параметры функции"]

Чтобы реализованные классы и методы имели локализованное название, при отображении в окне параметров "Универсальной функции", пометьте эти сущности специальным атрибутом `ResName`.

[source,csharp]
----
using System;
using System.Xml;
using System.ComponentModel; <.>

using DocsVision.Workflow.Gates; <.>

namespace SampleCode
{ 
 [ResName("Пример функции")]
 public class SampleFunc
 {
  [ResName("Пример метода функции")]
  public static void SaveCard([ResName("Переменная")] DVCard card)
  {
<.>

  }
 }

 // internal sealed class ResNameAttribute : DescriptionAttribute 
}
----
<.> Подключение системных библиотек.
<.> Подключение библиотек СУБП.
<.> Выполнение действий с объектом card.

.Класс `ResNameAttribute` требуется реализовать самостоятельно по следующему примеру:
[source,csharp]
----
[System.AttributeUsage(System.AttributeTargets.All)]
internal sealed class ResNameAttribute : DescriptionAttribute 
{ 
 public ResNameAttribute(string name) : base(name) { }
}
----

Данный класс может быть включен в сборку с получаемым _сценарием_, либо вынесен в отдельную библиотеку.

После получения библиотеки с локализованными названиями, окно настройки "Универсальной функции" будет как показано ниже.

.Параметры универсальной функции
image::universal-function.png[Параметры универсальной функции]

Помимо сборок, созданных на базе _сценариев_, возможно подключение в таком качестве любых произвольных сборок, отвечающих тем же требованиям. Данные библиотеки должны быть самостоятельно зарегистрированы в качестве модуля Workflow. Регистрация осуществляется в категории "Настройки Workflow/Сборки" справочника "Системные настройки" (папка "Конструкторы и справочники") приложения *Docsvision {wincl}*. Сборка должна быть доступна сервису Workflow (см. выше).
